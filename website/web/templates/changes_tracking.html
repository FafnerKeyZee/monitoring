{% extends "base.html" %}

{% from 'bootstrap5/utils.html' import render_messages %}

{% block title %}Changes{% endblock %}

{% block content %}

{{ render_messages(container=True, dismissible=True) }}

<div class="container">
  <ul>
    <li>Capture settings (to change them, please trigger a new monitoring from lookyloo):
      <pre>
      {{details['capture_settings']}}
      </pre>
    </li>
    {% if 'next_capture' in details%}
    <li>Next capture: {{details['next_capture'].isoformat() }}</li>
    {%endif%}
    {% if details['number_captures'] == 0%}
    <li>No captures available</li>
    {% elif details['number_captures'] == 1%}
    <li>Only one capture available, cannot compare yet.</li>
    {%else%}
    <li>{{details['number_captures']}} captures available.</li>
    <li>Last one triggered at {{details['last_capture'].isoformat()}}</li>
    {%endif%}
  </ul>

  <form method="POST" action="{{ url_for('changes_tracking', monitor_uuid=monitor_uuid)}}">
    {{ monitoring_form.csrf_token }}
    <div class="mb-3">
    {{ monitoring_form.frequency.label }} {{ monitoring_form.frequency(size=20) }}
    </div>
    <div class="mb-3">
    {{ monitoring_form.expire_at.label }} {{ monitoring_form.expire_at(size=20) }}
    </div>
    <div class="mb-3">
    {{ monitoring_form.collection.label }} {{ monitoring_form.collection(size=20) }}
    </div>
    <div class="mb-3">
    {{ monitoring_form.compare_settings}}
    </div>

    {% if current_user.is_authenticated %}
    <div class="mb-3">
    {{ monitoring_form.notification}}
    </div>
    {% endif %}

    {% if current_user.is_authenticated %}
    <input type="submit" value="Update">
    {%else%}
    <div class="mb-3">
        You must be authenticated to change the settings.
    </div>
    {% endif %}
  </form>

  {% if 'lookyloo_urls' in changes%}
  <h4>Links to the captures on Lookyloo</h4>
  <ul>
      <li><a href="{{changes['lookyloo_urls']['left']}}">Old capture</a></li>
      <li><a href="{{changes['lookyloo_urls']['right']}}">New capture</a></li>
  </ul>
  {%endif%}
  <hr>
  {% if changes['different'] is false %}
   Both captures are the same.
   <pre>
   {{changes_txt}}
   </pre>
  {% else %}
   Comparison of the two most recent captures:
   <ul>
   {% for k, info in changes.items() %}
     {% if k in ['root_url', 'final_url', 'final_hostname', 'final_status_code', 'redirects', 'error'] %}
       {% if k == 'redirects' %}
       <li>{{ info['length']['message'] }} ({{info['length']['details']}})</li>
       <li>Nodes to the landing page</li>
       <ol class="list-group-numbered">
       {%for node_details in info['nodes']%}
           {%for _, node in node_details.items() %}
           <li class="list-group-item">{{node['message']}}
               {% if node['details'] is string or node['details'] is integer %}
                   ({{node['details']}})
               {%else%}
                   <ul>
                       {% for entry in node['details'] %}
                       <li>{{entry}}</li>
                       {% endfor %}
                   </ul>
               {%endif%}
           </li>
           {% endfor %}

       {% endfor %}
       </ol>

       {% else %}
       <li>{{info['message']}}
           {% if info['details'] is string or info['details'] is integer %}
               ({{info['details']}})
           {%else%}
               <ul>
                   {% for entry in info['details'] %}
                   <li>{{entry}}</li>
                   {% endfor %}
               </ul>
           {%endif%}
       </li>
       {%endif%}

     {% elif k == 'ressources' %}
     <li>Ressources in both captures:</li>
     <ul>
       {% for url in info['both']%}
       <li>{{url}}</li>
       {% endfor %}
     </ul>
     <li>Ressources in moth recent capture only:</li>
     <ul>
       {% for url in info['left']%}
       <li>{{url}}</li>
       {% endfor %}
     </ul>
     <li>Ressources in oldest capture only:</li>
     <ul>
       {% for url in info['right']%}
       <li>{{url}}</li>
       {% endfor %}
     </ul>
     {%endif%}
   {% endfor %}
   </ul>
  <pre>
  {{changes_txt}}
  </pre>
  {% endif %}
</div>



{% endblock %}
